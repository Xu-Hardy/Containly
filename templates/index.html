<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <title>Containly 容器面板</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
:root {
  --bg: linear-gradient(145deg, #e0eafc, #cfdef3);
  --text: #2c3e50;
  --tag-bridge: #17a2b8;
  --tag-host: #6f42c1;
  --status-open: #28a745;
  --status-closed: #dc3545;
  --copy-bg: #fff3cd;
}

body.dark {
  --bg: #121212;
  --text: #f0f0f0;
}

* {
  box-sizing: border-box;
  margin: 0;
  padding: 0;
}

body {
  padding: 2rem;
  font-family: "Segoe UI", sans-serif;
  background-color: var(--bg);
  color: var(--text);
  transition: background 0.3s, color 0.3s;
}

h1 {
  font-size: 1.8rem;
  margin-bottom: 1rem;
}

input[type="text"] {
  padding: 0.5rem;
  font-size: 1rem;
  border: 1px solid #ccc;
  border-radius: 6px;
  width: 240px;
  outline: none;
}

.top-bar {
  display: flex;
  align-items: center;
  gap: 1rem;
  flex-wrap: wrap;
}

.dark-toggle {
  margin-left: auto;
  cursor: pointer;
  padding: 6px 10px;
  border: 1px solid #999;
  border-radius: 6px;
  background-color: transparent;
  font-size: 1rem;
  transition: background 0.2s;
}
.dark-toggle:hover {
  background-color: rgba(255,255,255,0.3);
}

.blacklist-link {
  text-decoration: none;
  color: inherit;
  border: 1px solid #999;
  border-radius: 6px;
  padding: 6px 10px;
  font-size: 1rem;
  transition: background 0.2s;
}
.blacklist-link:hover {
  background-color: rgba(255,255,255,0.3);
}

.section {
  margin-top: 2rem;
}

.section h2 {
  font-size: 1.4rem;
  margin-bottom: 0.5rem;
}

.grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(330px, 1fr));
  gap: 1.5rem;
  margin-top: 1rem;
}

.card {
  position: relative;
  padding: 1.5rem;
  border-radius: 16px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.1);
  color: #fff;
  animation: fadeIn 0.6s ease;
}

/* 渐变背景色 */
.card:nth-child(6n+1) { background: linear-gradient(135deg, #74ebd5, #acb6e5); }
.card:nth-child(6n+2) { background: linear-gradient(135deg, #fbc2eb, #a6c1ee); }
.card:nth-child(6n+3) { background: linear-gradient(135deg, #ffecd2, #fcb69f); }
.card:nth-child(6n+4) { background: linear-gradient(135deg, #c2e9fb, #a1c4fd); }
.card:nth-child(6n+5) { background: linear-gradient(135deg, #f6d365, #fda085); }
.card:nth-child(6n+6) { background: linear-gradient(135deg, #d4fc79, #96e6a1); }

.card h3 {
  font-size: 1.2rem;
  margin-bottom: 0.4rem;
}

.tag {
  background-color: var(--tag-bridge);
  padding: 3px 8px;
  border-radius: 4px;
  font-size: 0.8rem;
  display: inline-block;
}

.tag.host {
  background-color: var(--tag-host);
}

.port-list {
  margin-top: 1rem;
}

.port-item {
  margin-bottom: 0.5rem;
  font-size: 0.95rem;
}

.copyable {
  background-color: rgba(255,255,255,0.25);
  padding: 2px 6px;
  border-radius: 4px;
  cursor: pointer;
  font-weight: bold;
  font-family: monospace;
  transition: background 0.2s;
}
.copyable:hover {
  background-color: var(--copy-bg);
  color: #000;
}

a {
  color: #fff;
  text-decoration: underline;
  font-weight: 500;
}

.status-indicator {
  display: inline-block;
  width: 10px;
  height: 10px;
  border-radius: 50%;
  margin-left: 6px;
}

.open {
  background-color: var(--status-open);
}
.closed {
  background-color: var(--status-closed);
}

@keyframes fadeIn {
  from { opacity: 0; transform: translateY(10px); }
  to { opacity: 1; transform: translateY(0); }
}

/* 右上角竖排按钮 */
.card-actions {
 position: absolute;
  top: 8px;
  right: 8px;
  display: flex;
  flex-direction: column;
  gap: 0.3rem;
  opacity: 0;
  visibility: hidden;
  transition: opacity 0.3s, visibility 0.3s;
}

.card.show-actions .card-actions {
  opacity: 1;
  visibility: visible;
}

.action-btn {
  cursor: pointer;
  border: 1px solid #999;
  border-radius: 6px;
  font-size: 0.75rem;
  background-color: transparent;
  padding: 4px 8px;
  color: #fff;
  transition: background 0.2s;
}
.action-btn:hover {
  background-color: rgba(255,255,255,0.3);
}
  </style>
</head>
<body>
  <div class="top-bar">
    <h1>Containly 容器面板</h1>
    <label for="host-ip">宿主机 IP：</label>
    <input type="text" id="host-ip" placeholder="例如 192.168.1.100" />
    <a href="/blacklist" class="blacklist-link">黑名单管理</a>
    <!-- 夜间模式按钮，初始显示“🌜”或“🌞”根据需要可手动改 -->
    <button class="dark-toggle" id="darkBtn">🌙</button>
  </div>

  {% for status, containers in grouped.items() %}
  <div class="section">
    <h2>{{ status|capitalize }} 容器</h2>
    <div class="grid">
      {% for c in containers %}
      <!-- 修复 div 未闭合问题：data-protocol="http" 后面加 > -->
      <div
        class="card"
        data-container-id="{{ c.id }}"
        data-container-name="{{ c.name }}"
        data-protocol="http"
      >
        <!-- 右上角按钮组(竖排) -->
        <div class="card-actions">
          {% if c.status == "running" %}
          <button class="action-btn stop-btn" data-id="{{ c.id }}">🛑</button>
          <button class="action-btn restart-btn" data-id="{{ c.id }}">🔄</button>
          {% elif c.status == "exited" %}
          <button class="action-btn start-btn" data-id="{{ c.id }}">▶️</button>
          {% endif %}
          <button class="action-btn protocol-btn">🔐</button>
          <button class="action-btn blacklist-btn">🚫</button>
        </div>

        <h3>{{ c.name }}</h3>
        <div class="tag {{ 'host' if c.network == 'host' else '' }}">{{ c.network }}</div>
        <div class="port-list">
          {% for p in c.ports %}
          <div class="port-item" data-host="{{ p.host_port }}" data-container="{{ p.container_port }}">
            Host: <span class="copyable host-port">{{ p.host_port }}</span> |
            Container: <span class="copyable container-port">{{ p.container_port }}</span> –
            <a href="#" class="port-link" target="_blank">跳转</a>
            <span class="status-indicator" title="检测中..."></span>
          </div>
          {% endfor %}
        </div>
      </div>
      {% endfor %}
    </div>
  </div>
  {% endfor %}

  <script>
    const ipInput = document.getElementById("host-ip");
    ipInput.value = localStorage.getItem("host_ip") || "";

    /* 夜间模式: 用日/月图标 */
    function toggleDark() {
      document.body.classList.toggle("dark");
      const isDark = document.body.classList.contains("dark");
      localStorage.setItem("theme", isDark ? "dark" : "light");
      document.getElementById("darkBtn").textContent = isDark ? "☀️" : "🌙";
    }

    /* 更新端口链接 + 在线检测 */
    function updateLinks() {
      const ip = ipInput.value.trim();
      localStorage.setItem("host_ip", ip);

      document.querySelectorAll(".card").forEach(card => {
        const protocol = card.dataset.protocol || "http";
        card.querySelectorAll(".port-item").forEach(item => {
          const port = item.dataset.host;
          const link = item.querySelector(".port-link");
          const indicator = item.querySelector(".status-indicator");

          if (ip && port) {
            const url = `${protocol}://${ip}:${port}`;
            link.href = url;
            link.textContent = url;

            fetch(url, { method: 'HEAD', mode: 'no-cors' })
              .then(() => {
                indicator.classList.add("open");
                indicator.classList.remove("closed");
                indicator.title = "端口在线";
              })
              .catch(() => {
                indicator.classList.add("closed");
                indicator.classList.remove("open");
                indicator.title = "端口不可达";
              });
          } else {
            link.href = "#";
            link.textContent = "跳转";
            indicator.classList.remove("open", "closed");
            indicator.title = "";
          }
        });
      });
    }

    /* 复制端口号 */
    function enableCopy() {
      document.querySelectorAll(".copyable").forEach(el => {
        el.addEventListener("click", () => {
          navigator.clipboard.writeText(el.textContent.trim());
          el.style.backgroundColor = "#c1f0d1";
          setTimeout(() => {
            el.style.backgroundColor = "";
          }, 600);
        });
      });
    }

    /* 启动/停止/重启 */
    function initContainerActions() {
      // 启动
      document.querySelectorAll(".start-btn").forEach(btn => {
        btn.addEventListener("click", () => {
          fetch(`/container/${btn.dataset.id}/start`, { method: "POST" })
            .then(() => location.reload())
            .catch(err => console.error(err));
        });
      });
      // 停止
      document.querySelectorAll(".stop-btn").forEach(btn => {
        btn.addEventListener("click", () => {
          fetch(`/container/${btn.dataset.id}/stop`, { method: "POST" })
            .then(() => location.reload())
            .catch(err => console.error(err));
        });
      });
      // 重启
      document.querySelectorAll(".restart-btn").forEach(btn => {
        btn.addEventListener("click", () => {
          fetch(`/container/${btn.dataset.id}/restart`, { method: "POST" })
            .then(() => location.reload())
            .catch(err => console.error(err));
        });
      });
    }

    /* HTTP/HTTPS切换 + 按钮文字 */
    function initProtocolToggle() {
      document.querySelectorAll(".protocol-btn").forEach(btn => {
        btn.addEventListener("click", () => {
          const card = btn.closest(".card");
          const current = card.dataset.protocol || "http";
          if (current === "http") {
            card.dataset.protocol = "https";
            btn.textContent = "🔓";
          } else {
            card.dataset.protocol = "http";
            btn.textContent = "🔐";
          }
          updateLinks();
        });
      });
    }

    /* 拉黑容器 (前端 localStorage) */
    function initBlacklist() {
      const blacklisted = JSON.parse(localStorage.getItem("blacklisted_containers") || "[]");

      // 隐藏已拉黑的卡片
      document.querySelectorAll(".card").forEach(card => {
        const name = card.dataset.containerName;
        if (blacklisted.includes(name)) {
          card.style.display = "none";
        }
      });

      // 点击拉黑
      document.querySelectorAll(".blacklist-btn").forEach(btn => {
        btn.addEventListener("click", () => {
          const card = btn.closest(".card");
          const name = card.dataset.containerName;
          if (!blacklisted.includes(name)) {
            blacklisted.push(name);
            localStorage.setItem("blacklisted_containers", JSON.stringify(blacklisted));
          }
          card.style.display = "none";
        });
      });
    }


function initCardToggleActions() {
  document.querySelectorAll(".card").forEach(card => {
    let isActionsVisible = false;

    card.addEventListener("click", (e) => {
      if (e.target.classList.contains('action-btn')) return;
      isActionsVisible = !isActionsVisible;
      card.classList.toggle("show-actions", isActionsVisible);
    });

    card.addEventListener("mouseenter", () => {
      card.classList.add("show-actions");
    });

    card.addEventListener("mouseleave", () => {
      if (!isActionsVisible) {
        card.classList.remove("show-actions");
      }
    });
  });
}
    // DOM 加载后

    window.addEventListener("DOMContentLoaded", () => {
      // 恢复夜间模式
      const theme = localStorage.getItem("theme");
      if (theme === "dark") {
        document.body.classList.add("dark");
        document.getElementById("darkBtn").textContent = "☀️";
      } else {
        document.getElementById("darkBtn").textContent = "🌙";
      }

      // 绑定夜间模式切换
      document.getElementById("darkBtn").addEventListener("click", toggleDark);

      enableCopy();
      initContainerActions();
      initProtocolToggle();
      initBlacklist();
      updateLinks();
      initCardToggleActions();
      initCardToggleActions(); // ← 新增这一行

      ipInput.addEventListener("input", updateLinks);
    });
  </script>
</body>
</html>
